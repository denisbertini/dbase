(function(a){if(typeof define==="function"&&define.amd){define(["jquery","jquery-ui","d3","JSRootPainter","THREE","three.extra","THREE_ALL","JSRootPainter.jquery"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRoot3DPainter.js")}if(typeof d3!="object"){throw new Error("This extension requires d3.v3.js","JSRoot3DPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRoot3DPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRoot3DPainter.js")}a(jQuery,jQuery.ui,d3,JSROOT)}}(function(c,d,b,a){a.Painter.add3DInteraction=function(){var m=this;var g,f,h=false;var j={x:0,y:0},l;var o=function(){var q="tt";var C=3;var s=3;var B=150;var u=10;var r=20;var x=95;var v=0;var y,D,z,A,w;var p=document.all?true:false;return{show:function(E,t){if(y==null){y=document.createElement("div");y.setAttribute("id",q);D=document.createElement("div");D.setAttribute("id",q+"top");z=document.createElement("div");z.setAttribute("id",q+"cont");A=document.createElement("div");A.setAttribute("id",q+"bot");y.appendChild(D);y.appendChild(z);y.appendChild(A);document.body.appendChild(y);y.style.opacity=0;y.style.filter="alpha(opacity=0)";document.onmousemove=this.pos}y.style.display="block";z.innerHTML=E;y.style.width=t?t+"px":"auto";y.style.width="auto";if(!t&&p){D.style.display="none";A.style.display="none";y.style.width=y.offsetWidth;D.style.display="block";A.style.display="block"}w=parseInt(y.offsetHeight)+C;clearInterval(y.timer);y.timer=setInterval(function(){o.fade(1)},r)},pos:function(F){var E=p?event.clientY+document.documentElement.scrollTop:F.pageY;var t=p?event.clientX+document.documentElement.scrollLeft:F.pageX;y.style.top=E+15+"px";y.style.left=(t+s)+"px"},fade:function(F){var t=v;if((t!=x&&F==1)||(t!=0&&F==-1)){var E=u;if(x-t<u&&F==1){E=x-t}else{if(v<u&&F==-1){E=t}}v=t+(E*F);y.style.opacity=v*0.01;y.style.filter="alpha(opacity="+v+")"}else{clearInterval(y.timer);if(F==-1){y.style.display="none"}}},hide:function(){if(y==null){return}clearInterval(y.timer);y.timer=setInterval(function(){o.fade(-1)},r)}}}();var i=100;var e=0;var k=new THREE.Raycaster();function n(){if(h){if(l){l.material.emissive.setHex(l.currentHex);m.Render3D()}l=null;if(a.gStyle.Tooltip){o.hide()}return}k.setFromCamera(j,m.camera);var r=k.intersectObjects(m.scene.children,true);if(r.length>0){var q=null;for(var p=0;p<r.length;++p){if("emissive" in r[p].object.material){q=r[p];break}}if(q&&l!=q.object){if(l){l.material.emissive.setHex(l.currentHex)}l=q.object;l.currentHex=l.material.emissive.getHex();l.material.emissive.setHex(6250335);m.Render3D();if(a.gStyle.Tooltip){o.show(l.name.length>0?l.name:l.parent.name,200)}}}else{if(l){l.material.emissive.setHex(l.currentHex);m.Render3D()}l=null;if(a.gStyle.Tooltip){o.hide()}}}c(m.renderer.domElement).on("touchstart mousedown",function(p){if(a.gStyle.Tooltip){o.hide()}p.preventDefault();var q=p;if("changedTouches" in p){q=p.changedTouches[0]}else{if("touches" in p){q=p.touches[0]}else{if("originalEvent" in p){if("changedTouches" in p.originalEvent){q=p.originalEvent.changedTouches[0]}else{if("touches" in p.originalEvent){q=p.originalEvent.touches[0]}}}}}g=q.pageX;f=q.pageY;h=true});c(m.renderer.domElement).on("touchmove mousemove",function(t){if(h){var u=t;if("changedTouches" in t){u=t.changedTouches[0]}else{if("touches" in t){u=t.touches[0]}else{if("originalEvent" in t){if("changedTouches" in t.originalEvent){u=t.originalEvent.changedTouches[0]}else{if("touches" in t.originalEvent){u=t.originalEvent.touches[0]}}}}}var s=u.pageX-g;var r=u.pageY-f;if((r>0&&m.toplevel.rotation.x<Math.PI*3/4)||(r<0&&m.toplevel.rotation.x>-Math.PI/4)){m.toplevel.rotation.x+=r*0.02}m.toplevel.rotation.y+=s*0.02;m.Render3D();g=u.pageX;f=u.pageY}else{t.preventDefault();var q="offsetX" in t.originalEvent?t.originalEvent.offsetX:t.originalEvent.layerX;var p="offsetY" in t.originalEvent?t.originalEvent.offsetY:t.originalEvent.layerY;j.x=(q/m.renderer.domElement.width)*2-1;j.y=-(p/m.renderer.domElement.height)*2+1;n()}});c(m.renderer.domElement).on("touchend mouseup",function(p){h=false});c(m.renderer.domElement).on("mousewheel",function(p,q){p.preventDefault();m.camera.position.z+=q*20;m.Render3D()});c(m.renderer.domElement).on("contextmenu",function(p){p.preventDefault();if(a.gStyle.Tooltip){o.hide()}return m.ShowContextMenu("hist",p.originalEvent)})};a.Painter.HPainter_Create3DScene=function(e){if((e!=null)&&(e<0)){this.clear_3d_canvas();delete this.size3d;delete this.scene;delete this.toplevel;delete this.camera;delete this.renderer;return}if("toplevel" in this){var h=new THREE.Object3D();h.rotation.x=this.toplevel.rotation.x;h.rotation.y=this.toplevel.rotation.y;this.scene.remove(this.toplevel);this.scene.add(h);this.toplevel=h;return}var g=this.size_for_3d();this.size3d=100;this.scene=new THREE.Scene();this.toplevel=new THREE.Object3D();this.toplevel.rotation.x=30*Math.PI/180;this.toplevel.rotation.y=30*Math.PI/180;this.scene.add(this.toplevel);this.camera=new THREE.PerspectiveCamera(45,g.width/g.height,1,4000);var f=new THREE.PointLight(13619151);this.camera.add(f);f.position.set(10,10,10);this.camera.position.set(0,this.size3d/2,500);this.scene.add(this.camera);var i={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(j){return false}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob};this.renderer=i.webgl?new THREE.WebGLRenderer({antialias:true,alpha:true}):new THREE.CanvasRenderer({antialias:true,alpha:true});this.renderer.setSize(g.width,g.height);this.add_3d_canvas(this.renderer.domElement);this["CreateXYZ"]=a.Painter.HPainter_CreateXYZ;this["DrawXYZ"]=a.Painter.HPainter_DrawXYZ;this["Add3DInteraction"]=a.Painter.add3DInteraction;this["Render3D"]=a.Painter.Render3D;this.Add3DInteraction()};a.Painter.HPainter_CreateXYZ=function(){var i=this.xmin,g=this.xmax;var h=this.ymin,e=this.ymax;var f=this.gminbin,j=this.gmaxbin;if(("zmin" in this)&&("zmax" in this)&&(this.Dimension()==3)){f=this.zmin;j=this.zmax}else{j=Math.ceil(j/100)*105}if(this.options.Logx){if(i<=0){i=0.000001*g}this.tx=b.scale.log().domain([i,g]).range([-this.size3d,this.size3d]);this.utx=b.scale.log().domain([-this.size3d,this.size3d]).range([i,g])}else{this.tx=b.scale.linear().domain([i,g]).range([-this.size3d,this.size3d]);this.utx=b.scale.linear().domain([-this.size3d,this.size3d]).range([i,g])}if(this.options.Logy){if(h<=0){h=0.000001*e}this.ty=b.scale.log().domain([h,e]).range([-this.size3d,this.size3d]);this.uty=b.scale.log().domain([this.size3d,-this.size3d]).range([h,e])}else{this.ty=b.scale.linear().domain([h,e]).range([-this.size3d,this.size3d]);this.uty=b.scale.linear().domain([this.size3d,-this.size3d]).range([h,e])}if(this.options.Logz){if(f<=0){f=0.000001*j}this.tz=b.scale.log().domain([f,j]).range([0,this.size3d*2]);this.utz=b.scale.log().domain([0,this.size3d*2]).range([f,j])}else{this.tz=b.scale.linear().domain([f,j]).range([0,this.size3d*2]);this.utz=b.scale.linear().domain([0,this.size3d*2]).range([f,j])}};a.Painter.HPainter_DrawXYZ=function(){var B=new THREE.MeshBasicMaterial({color:0});var G=new THREE.LineBasicMaterial({color:0});var J=new Array();var o,g,D=3,r,e=Math.sin(45);var F,v;var K=this.tx.ticks(8);var w=this.tx.ticks(50);for(var C=-this.size3d,A=0,z=0;C<this.size3d;++C){var n=(this.utx(C)<=K[A]&&this.utx(C+1)>K[A])?true:false;var y=(this.utx(C)<=w[z]&&this.utx(C+1)>w[z])?true:false;r=(n?D+2:D)*e;if(n){F=new THREE.TextGeometry(K[A],{size:7,height:0,curveSegments:10});++A;F.computeBoundingBox();var h=0.5*(F.boundingBox.max.x-F.boundingBox.min.x);v=new THREE.Mesh(F,B);v.position.set(C-h,-13,this.size3d+r);this.toplevel.add(v);v=new THREE.Mesh(F,B);v.position.set(C+h,-13,-this.size3d-r);v.rotation.y=Math.PI;this.toplevel.add(v)}if(n||y){++z;var l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(C,0,this.size3d));l.vertices.push(new THREE.Vector3(C,-r,this.size3d+r));this.toplevel.add(new THREE.Line(l,G));J.push(l);l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(C,0,-this.size3d));l.vertices.push(new THREE.Vector3(C,-r,-this.size3d-r));this.toplevel.add(new THREE.Line(l,G));J.push(l)}}var I=this.ty.ticks(8);var s=this.ty.ticks(50);for(var C=this.size3d,A=0,z=0;C>-this.size3d;--C){var n=(this.uty(C)<=I[A]&&this.uty(C-1)>I[A])?true:false;var y=(this.uty(C)<=s[z]&&this.uty(C-1)>s[z])?true:false;r=(n?D+2:D)*e;if(n){F=new THREE.TextGeometry(I[A],{size:7,height:0,curveSegments:10});++A;F.computeBoundingBox();var h=0.5*(F.boundingBox.max.x-F.boundingBox.min.x);v=new THREE.Mesh(F,B);v.position.set(this.size3d+r,-13,C+h);v.rotation.y=Math.PI/2;this.toplevel.add(v);v=new THREE.Mesh(F,B);v.position.set(-this.size3d-r,-13,C-h);v.rotation.y=-Math.PI/2;this.toplevel.add(v)}if(n||y){++z;var l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(this.size3d,0,C));l.vertices.push(new THREE.Vector3(this.size3d+r,-r,C));this.toplevel.add(new THREE.Line(l,G));J.push(l);l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(-this.size3d,0,C));l.vertices.push(new THREE.Vector3(-this.size3d-r,-r,C));this.toplevel.add(new THREE.Line(l,G));J.push(l)}}var H=this.tz.ticks(8);var q=this.tz.ticks(50);for(var C=0,A=0,z=0;C<2*this.size3d;++C){var n=(this.utz(C)<=H[A]&&this.utz(C+1)>H[A])?true:false;var y=(this.utz(C)<=q[z]&&this.utz(C+1)>q[z])?true:false;r=(n?D+2:D)*e;if(n){F=new THREE.TextGeometry(H[A],{size:7,height:0,curveSegments:10});++A;F.computeBoundingBox();var m=0.8*(F.boundingBox.max.x-F.boundingBox.min.x);v=new THREE.Mesh(F,B);v.position.set(this.size3d+m+5,C-2.5,this.size3d+m+5);v.rotation.y=Math.PI*3/4;this.toplevel.add(v);v=new THREE.Mesh(F,B);v.position.set(this.size3d+m+5,C-2.5,-this.size3d-m-5);v.rotation.y=-Math.PI*3/4;this.toplevel.add(v);v=new THREE.Mesh(F,B);v.position.set(-this.size3d-m-5,C-2.5,this.size3d+m+5);v.rotation.y=Math.PI/4;this.toplevel.add(v);v=new THREE.Mesh(F,B);v.position.set(-this.size3d-m-5,C-2.5,-this.size3d-m-5);v.rotation.y=-Math.PI/4;this.toplevel.add(v)}if(n||y){++z;var l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(this.size3d,C,this.size3d));l.vertices.push(new THREE.Vector3(this.size3d+r,C,this.size3d+r));this.toplevel.add(new THREE.Line(l,G));J.push(l);l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(this.size3d,C,-this.size3d));l.vertices.push(new THREE.Vector3(this.size3d+r,C,-this.size3d-r));this.toplevel.add(new THREE.Line(l,G));J.push(l);l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(-this.size3d,C,this.size3d));l.vertices.push(new THREE.Vector3(-this.size3d-r,C,this.size3d+r));this.toplevel.add(new THREE.Line(l,G));J.push(l);l=new THREE.Geometry();l.vertices.push(new THREE.Vector3(-this.size3d,C,-this.size3d));l.vertices.push(new THREE.Vector3(-this.size3d-r,C,-this.size3d-r));this.toplevel.add(new THREE.Line(l,G));J.push(l)}}for(var u=0;u<J.length;++u){J[u].dispose()}var E=new THREE.MeshBasicMaterial({color:0,wireframe:true,wireframeLinewidth:0.5,side:THREE.DoubleSide});var x=new THREE.Mesh(new THREE.BoxGeometry(this.size3d*2,this.size3d*2,this.size3d*2),E);var f=new THREE.BoxHelper(x);f.material.color.set(0);var p=new THREE.Object3D();p.add(f);p.position.y=this.size3d;this.toplevel.add(p);this.camera.lookat=x};a.Painter.TH2Painter_Draw3DBins=function(){var m=(this.size3d*2/this.nbinsx)/this.gmaxbin;var k=(this.size3d*2/this.nbinsy)/this.gmaxbin;var n=b.rgb(a.Painter.root_colors[this.histo.fFillColor]);var e=this.CreateDrawBins(100,100,2,(a.gStyle.Tooltip?1:0));var j=new THREE.Color(14540253);j.setRGB(n.r/255,n.g/255,n.b/255);for(var l=0;l<e.length;++l){var h=e[l];var f=this.tz(h.z);var o=new THREE.Mesh(new THREE.BoxGeometry(2*this.size3d/this.nbinsx,f,2*this.size3d/this.nbinsy),new THREE.MeshLambertMaterial({color:j.getHex()}));o.position.x=this.tx(h.x);o.position.y=f/2;o.position.z=-(this.ty(h.y));if(a.gStyle.Tooltip){o.name=h.tip}this.toplevel.add(o);var g=new THREE.BoxHelper(o);g.material.color.set(0);g.material.linewidth=1;this.toplevel.add(g)}delete e;e=null};a.Painter.Render3D=function(e){if(e==null){e=10}if(e<=0){if("render_tmout" in this){clearTimeout(this["render_tmout"])}this.renderer.render(this.scene,this.camera);delete this["render_tmout"];return}if("render_tmout" in this){return}this["render_tmout"]=setTimeout(this.Render3D.bind(this,0),e)};a.Painter.TH2Painter_Draw3D=function(e){this.Create3DScene();this.CreateXYZ();this.DrawXYZ();this.Draw3DBins();this.Render3D();a.CallBack(e)};a.TH3Painter=function(e){a.THistPainter.call(this,e);this["Create3DScene"]=a.Painter.HPainter_Create3DScene};a.TH3Painter.prototype=Object.create(a.THistPainter.prototype);a.TH3Painter.prototype.ScanContent=function(){this.nbinsx=this.histo.fXaxis["fNbins"];this.nbinsy=this.histo.fYaxis["fNbins"];this.nbinsz=this.histo.fZaxis["fNbins"];this.xmin=this.histo.fXaxis["fXmin"];this.xmax=this.histo.fXaxis["fXmax"];this.ymin=this.histo.fYaxis["fXmin"];this.ymax=this.histo.fYaxis["fXmax"];this.zmin=this.histo.fZaxis["fXmin"];this.zmax=this.histo.fZaxis["fXmax"];this.gminbin=this.gmaxbin=this.histo.getBinContent(1,1,1);for(var g=0;g<this.nbinsx;++g){for(var f=0;f<this.nbinsy;++f){for(var e=0;e<this.nbinsz;++e){var h=this.histo.getBinContent(g+1,f+1,e+1);if(h<this.gminbin){this.gminbin=h}else{if(h>this.gmaxbin){this.gmaxbin=h}}}}}this.draw_content=this.gmaxbin>0};a.TH3Painter.prototype.CountStat=function(){var i=0,m=0,r=0,f=0,l=0,q=0,e=0;var v={entries:0,integral:0,meanx:0,meany:0,meanz:0,rmsx:0,rmsy:0,rmsz:0};for(var o=0;o<this.nbinsx+2;++o){var k=this.xmin+(o-0.5)/this.nbinsx*(this.xmax-this.xmin);var h=(o===0)?0:(o===this.nbinsx+1?2:1);for(var u=0;u<this.nbinsy+2;++u){var p=this.ymin+(u-0.5)/this.nbinsy*(this.ymax-this.ymin);var s=(u===0)?0:(u===this.nbinsy+1?2:1);for(var j=0;j<this.nbinsz+2;++j){var t=this.zmin+(j-0.5)/this.nbinsz*(this.zmax-this.zmin);var n=(j===0)?0:(j===this.nbinsz+1?2:1);var g=this.histo.getBinContent(o,u,j);v.entries+=g;if((h==1)&&(s==1)&&(n==1)){i+=g;m+=k*g;r+=p*g;f+=t*g;l+=k*k*g;q+=p*p*g;e+=t*t*g}}}}if(this.histo.fTsumw>0){i=this.histo.fTsumw;m=this.histo.fTsumwx;l=this.histo.fTsumwx2;r=this.histo.fTsumwy;q=this.histo.fTsumwy2;f=this.histo.fTsumwz;e=this.histo.fTsumwz2}if(i>0){v.meanx=m/i;v.meany=r/i;v.meanz=f/i;v.rmsx=Math.sqrt(l/i-v.meanx*v.meanx);v.rmsy=Math.sqrt(q/i-v.meany*v.meany);v.rmsz=Math.sqrt(e/i-v.meanz*v.meanz)}v.integral=i;if(this.histo.fEntries>1){v.entries=this.histo.fEntries}return v};a.TH3Painter.prototype.FillStatistic=function(i,j,q){if(!this.histo){return false}var h=this.CountStat();var l=j%10;var n=Math.floor(j/10)%10;var k=Math.floor(j/100)%10;var o=Math.floor(j/1000)%10;var e=Math.floor(j/10000)%10;var f=Math.floor(j/100000)%10;var g=Math.floor(j/1000000)%10;if(l>0){i.AddLine(this.histo.fName)}if(n>0){i.AddLine("Entries = "+i.Format(h.entries,"entries"))}if(k>0){i.AddLine("Mean x = "+i.Format(h.meanx));i.AddLine("Mean y = "+i.Format(h.meany));i.AddLine("Mean z = "+i.Format(h.meanz))}if(o>0){i.AddLine("Std Dev x = "+i.Format(h.rmsx));i.AddLine("Std Dev y = "+i.Format(h.rmsy));i.AddLine("Std Dev z = "+i.Format(h.rmsz))}if(g>0){i.AddLine("Integral = "+i.Format(h.integral,"entries"))}var m=i.pavetext.fLines.arr.length;var p=m*a.gStyle.StatFontSize;if(p<=0||3==(a.gStyle.StatFont%10)){p=0.25*m*a.gStyle.StatH;i.pavetext.fY1NDC=0.93-p;i.pavetext.fY2NDC=0.93}return true};a.TH3Painter.prototype.CreateBins=function(){var m=[];var g=this.GetItemName();if((g==null)||(g=="")){g=this.histo.fName}if(g.length>0){g+="\n"}for(var l=0;l<this.nbinsx;++l){for(var f=0;f<this.nbinsy;++f){for(var e=0;e<this.nbinsz;++e){var n=this.histo.getBinContent(l+1,f+1,e+1);if(n<=this.gminbin){continue}var h={x:this.xmin+(l+0.5)/this.nbinsx*(this.xmax-this.xmin),y:this.ymin+(f+0.5)/this.nbinsy*(this.ymax-this.ymin),z:this.zmin+(e+0.5)/this.nbinsz*(this.zmax-this.zmin),n:n};if(a.gStyle.Tooltip){h.tip=g+"x="+h.x+" bin="+(l+1)+"\ny="+h.y+" bin="+(f+1)+"\nz="+h.z+" bin="+(e+1)+"\nentries="+h.n}m.push(h)}}}return m};a.TH3Painter.prototype.Draw3DBins=function(){if(!this.draw_content){return}var n=this.CreateBins();var l=(this.size3d*2/this.nbinsx)/this.gmaxbin;var k=(this.size3d*2/this.nbinsy)/this.gmaxbin;var h=(this.size3d*2/this.nbinsz)/this.gmaxbin;var m=b.rgb(a.Painter.root_colors[this.histo.fFillColor]);var g=new THREE.Color(14540253);g.setRGB(m.r/255,m.g/255,m.b/255);var o,e;for(var j=0;j<n.length;++j){e=(this.options.Color>0?this.gmaxbin:n[j].n);if(this.options.Box==11){o=new THREE.Mesh(new THREE.SphereGeometry(0.5*e*l),new THREE.MeshPhongMaterial({color:g.getHex(),specular:5197647}))}else{o=new THREE.Mesh(new THREE.BoxGeometry(e*l,e*h,e*k),new THREE.MeshLambertMaterial({color:g.getHex()}))}o.position.x=this.tx(n[j].x);o.position.y=this.tz(n[j].z);o.position.z=-(this.ty(n[j].y));if("tip" in n[j]){o.name=n[j].tip}this.toplevel.add(o);if(this.options.Box!=11){var f=new THREE.BoxHelper(o);f.material.color.set(0);f.material.linewidth=1;this.toplevel.add(f)}}};a.TH3Painter.prototype.Redraw=function(){this.Create3DScene();this.CreateXYZ();this.DrawXYZ();this.Draw3DBins();this.Render3D()};a.Painter.drawHistogram3D=function(h,e,g){a.extend(this,new a.TH3Painter(e));this.SetDivId(h,4);this.options=this.DecodeOptions(g);this.CheckPadOptions();this.ScanContent();this.Redraw();if(this.create_canvas){this.DrawTitle()}if(a.gStyle.AutoStat&&this.create_canvas){var f=this.CreateStat();if(f){a.draw(this.divid,f,"")}}return this.DrawingReady()};a.Painter.drawPolyMarker3D=function(m,e,f){this.SetDivId(m);var k=this.main_painter();if((k==null)||!("renderer" in k)){return this.DrawingReady()}var i=e.fP.length;var h=3;if((a.gStyle.OptimizeDraw>0)&&(i>300*3)){h=Math.floor(i/300/3)*3;if(h<=6){h=6}}var l=b.rgb(a.Painter.root_colors[e.fMarkerColor]);var j=new THREE.Color(14540253);j.setRGB(l.r/255,l.g/255,l.b/255);for(var g=0;g<i;g+=h){var o=new THREE.Mesh(new THREE.SphereGeometry(1),new THREE.MeshPhongMaterial({color:j.getHex(),specular:5197647}));o.position.x=k.tx(e.fP[g]);o.position.y=k.tz(e.fP[g+2]);o.position.z=-k.ty(e.fP[g+1]);k.toplevel.add(o)}k.Render3D();return this.DrawingReady()};return a.Painter}));