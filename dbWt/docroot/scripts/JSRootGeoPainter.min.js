(function(a){if(typeof define==="function"&&define.amd){define(["JSRootPainter","THREE_ALL"],a)}else{if(typeof JSROOT=="undefined"){throw new Error("JSROOT is not defined","JSRootGeoPainter.js")}if(typeof JSROOT.Painter!="object"){throw new Error("JSROOT.Painter is not defined","JSRootGeoPainter.js")}if(typeof THREE=="undefined"){throw new Error("THREE is not defined","JSRootGeoPainter.js")}a(JSROOT)}}(function(a){if(typeof define==="function"&&define.amd){a.loadScript("$$$style/JSRootGeoPainter.css")}a.EGeoVisibilityAtt={kVisOverride:a.BIT(0),kVisNone:a.BIT(1),kVisThis:a.BIT(2),kVisDaughters:a.BIT(3),kVisOneLevel:a.BIT(4),kVisStreamed:a.BIT(5),kVisTouched:a.BIT(6),kVisOnScreen:a.BIT(7),kVisContainers:a.BIT(12),kVisOnly:a.BIT(13),kVisBranch:a.BIT(14),kVisRaytrace:a.BIT(15)};a.TestGeoAttBit=function(b,c){if(!("fGeoAtt" in b)){return false}return(b.fGeoAtt&c)!=0};a.ToggleGeoAttBit=function(b,c){if(!("fGeoAtt" in b)){return false}b.fGeoAtt=b.fGeoAtt^(c&16777215)};a.TGeoPainter=function(c){a.TBasePainter.call(this,c);this._debug=false;this._full=false;this._bound=false;this._grid=false;this._geometry=c;this._scene=null;this._renderer=null;var b=a.GetUrlOption("_grid");if(b!==null&&b=="true"){this._grid=true}var b=a.GetUrlOption("_debug");if(b!==null&&b=="true"){this._debug=true;this._grid=true}if(b!==null&&b=="bound"){this._debug=true;this._grid=true;this._bound=true}if(b!==null&&b=="full"){this._debug=true;this._grid=true;this._full=true;this._bound=true}};a.TGeoPainter.prototype=Object.create(a.TBasePainter.prototype);a.TGeoPainter.prototype.GetObject=function(){return this._geometry};a.TGeoPainter.prototype.addControls=function(e,f,d){if(typeof e.domElement.trackballControls!=="undefined"&&e.domElement.trackballControls!==null){return}e.domElement.clock=new THREE.Clock();e.domElement.trackballControls=new THREE.TrackballControls(d,e.domElement);e.domElement.trackballControls.rotateSpeed=5;e.domElement.trackballControls.zoomSpeed=0.8;e.domElement.trackballControls.panSpeed=0.2;e.domElement.trackballControls.noZoom=false;e.domElement.trackballControls.noPan=false;e.domElement.trackballControls.staticMoving=false;e.domElement.trackballControls.dynamicDampingFactor=0.25;e.domElement.trackballControls.target.set(0,0,0);e.domElement.transformControl=null;e.domElement.render=function(){var g=e.domElement.clock.getDelta();if(e.domElement.transformControl!==null){e.domElement.transformControl.update()}e.domElement.trackballControls.update(g);e.render(f,d)};if(this._debug||this._grid){e.domElement.transformControl=new THREE.TransformControls(d,e.domElement);e.domElement.transformControl.addEventListener("change",e.domElement.render);f.add(e.domElement.transformControl);window.addEventListener("keydown",function(g){switch(g.keyCode){case 81:e.domElement.transformControl.setSpace(e.domElement.transformControl.space==="local"?"world":"local");break;case 17:e.domElement.transformControl.setTranslationSnap(e.domElement._translationSnap);e.domElement.transformControl.setRotationSnap(THREE.Math.degToRad(15));break;case 84:e.domElement.transformControl.setMode("translate");break;case 82:e.domElement.transformControl.setMode("rotate");break;case 83:e.domElement.transformControl.setMode("scale");break;case 187:case 107:e.domElement.transformControl.setSize(e.domElement.transformControl.size+0.1);break;case 189:case 109:e.domElement.transformControl.setSize(Math.max(e.domElement.transformControl.size-0.1,0.1));break}});window.addEventListener("keyup",function(g){switch(g.keyCode){case 17:e.domElement.transformControl.setTranslationSnap(null);e.domElement.transformControl.setRotationSnap(null);break}})}e.domElement._timeoutFunc=null;e.domElement._animationId=null;var b=true;function c(){if(b===true){e.domElement._timeoutFunc=setTimeout(function(){e.domElement._animationId=requestAnimationFrame(c,e.domElement)},1000/30)}e.domElement.render()}c()};a.TGeoPainter.prototype.createCube=function(b,c,d){var e=new THREE.BoxGeometry(b.fDX,b.fDY,b.fDZ);return new THREE.Mesh(e,c)};a.TGeoPainter.prototype.createPolygon=function(b,o,w){var s=60;if(b._typename=="TGeoPgon"){s=b.fNedges}var r=[];var l=[];var e=[],A=[];var m=[],y=[];var d=[],z=[];var g=0;var p=360;g=b.fPhi1+90;p=b.fDphi;var c=(p<360)?true:false;if(w!==null&&w[4]===-1&&w[0]===1&&w[8]===1){g+=180}g*=(Math.PI/180);p*=(Math.PI/180);var h=new THREE.Geometry();for(var v=0;v<b.fNz;++v){r[v]=b.fRmax[v]/2;l[v]=b.fRmin[v]/2;if(l[v]<=0){l[v]=1e-7}}for(var q=0;q<b.fNz;++q){var x=q*2;var f=(b.fZ[q+1]-b.fZ[q])/2;e[x]=new THREE.CylinderGeometry(r[q+1],r[q],f,s,1,true,g,p);e[x].applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));e[x].faceVertexUvs[0]=[];A[x]=new THREE.Mesh(e[x],o);A[x].translateZ(0.5*(b.fZ[q]+f));e[x+1]=new THREE.CylinderGeometry(l[q+1],l[q],f,s,1,true,g,p);e[x+1].applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));e[x+1].faceVertexUvs[0]=[];A[x+1]=new THREE.Mesh(e[x+1],o);A[x+1].translateZ(0.5*(b.fZ[q]+f));if(q>=(b.fNz-2)){d[x]=new THREE.Geometry();for(v=0;v<s;++v){var u=v;var t=v*6;d[x].vertices.push(e[x].vertices[u+0]);d[x].vertices.push(e[x].vertices[u+1]);d[x].vertices.push(e[x+1].vertices[u+0]);d[x].faces.push(new THREE.Face3(t+0,t+1,t+2));d[x].vertices.push(e[x+1].vertices[u+0]);d[x].vertices.push(e[x+1].vertices[u+1]);d[x].vertices.push(e[x].vertices[u+1]);d[x].faces.push(new THREE.Face3(t+3,t+4,t+5))}d[x].mergeVertices();d[x].computeFaceNormals();z[x]=new THREE.Mesh(d[x],o);z[x].translateZ(0.5*(b.fZ[q]+f))}if(c){m[x]=new THREE.Geometry();m[x].vertices.push(e[x].vertices[0]);m[x].vertices.push(e[x].vertices[e[x].vertices.length/2]);m[x].vertices.push(e[x+1].vertices[e[x].vertices.length/2]);m[x].faces.push(new THREE.Face3(0,1,2));m[x].vertices.push(e[x+1].vertices[0]);m[x].vertices.push(e[x+1].vertices[e[x].vertices.length/2]);m[x].vertices.push(e[x].vertices[0]);m[x].faces.push(new THREE.Face3(3,4,5));m[x].mergeVertices();m[x].computeFaceNormals();y[x]=new THREE.Mesh(m[x],o);y[x].translateZ(0.5*(b.fZ[q]+f));m[x+1]=new THREE.Geometry();m[x+1].vertices.push(e[x].vertices[s]);m[x+1].vertices.push(e[x].vertices[e[x].vertices.length-1]);m[x+1].vertices.push(e[x+1].vertices[e[x].vertices.length-1]);m[x+1].faces.push(new THREE.Face3(0,1,2));m[x+1].vertices.push(e[x+1].vertices[s]);m[x+1].vertices.push(e[x+1].vertices[e[x].vertices.length-1]);m[x+1].vertices.push(e[x].vertices[s]);m[x+1].faces.push(new THREE.Face3(3,4,5));m[x+1].mergeVertices();m[x+1].computeFaceNormals();y[x+1]=new THREE.Mesh(m[x+1],o);y[x+1].translateZ(0.5*(b.fZ[q]+f))}if(q==0){d[x+1]=new THREE.Geometry();for(v=0;v<s;++v){var u=v;var t=v*6;d[x+1].vertices.push(e[x].vertices[e[x].vertices.length-2-u+0]);d[x+1].vertices.push(e[x].vertices[e[x].vertices.length-2-u+1]);d[x+1].vertices.push(e[x+1].vertices[e[x].vertices.length-2-u+0]);d[x+1].faces.push(new THREE.Face3(t+0,t+1,t+2));d[x+1].vertices.push(e[x+1].vertices[e[x].vertices.length-2-u+0]);d[x+1].vertices.push(e[x+1].vertices[e[x].vertices.length-2-u+1]);d[x+1].vertices.push(e[x].vertices[e[x].vertices.length-2-u+1]);d[x+1].faces.push(new THREE.Face3(t+3,t+4,t+5))}d[x+1].mergeVertices();d[x+1].computeFaceNormals();z[x+1]=new THREE.Mesh(d[x+1],o);z[x+1].translateZ(0.5*(b.fZ[q]+f))}A[x].updateMatrix();h.merge(A[x].geometry,A[x].matrix);A[x+1].updateMatrix();h.merge(A[x+1].geometry,A[x+1].matrix);if(c){y[x].updateMatrix();h.merge(y[x].geometry,y[x].matrix);y[x+1].updateMatrix();h.merge(y[x+1].geometry,y[x+1].matrix)}if(q>=(b.fNz-2)){z[x].updateMatrix();h.merge(z[x].geometry,z[x].matrix)}if(q==0){z[x+1].updateMatrix();h.merge(z[x+1].geometry,z[x+1].matrix)}}return new THREE.Mesh(h,o)};a.TGeoPainter.prototype.createSphere=function(d,r){var e=32;var s=32;var w=d.fRmax;var m=d.fRmin;var t=d.fPhi1+180;var v=d.fPhi2-d.fPhi1;var g=d.fTheta1;var u=d.fTheta2-d.fTheta1;g*=(Math.PI/180);u*=(Math.PI/180);t*=(Math.PI/180);v*=(Math.PI/180);var h=new THREE.Geometry();if(m<=0){m=1e-7}var f=new THREE.SphereGeometry(w/2,e,s,t,v,g,u);f.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));var z=new THREE.Mesh(f,r);var n=new THREE.SphereGeometry(m/2,e,s,t,v,g,u);n.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));var B=new THREE.Mesh(n,r);var l=new THREE.Geometry();for(i=0;i<e;++i){var y=i;var x=i*6;l.vertices.push(f.vertices[y+0]);l.vertices.push(f.vertices[y+1]);l.vertices.push(n.vertices[y+0]);l.faces.push(new THREE.Face3(x+0,x+1,x+2));l.vertices.push(n.vertices[y+0]);l.vertices.push(n.vertices[y+1]);l.vertices.push(f.vertices[y+1]);l.faces.push(new THREE.Face3(x+3,x+4,x+5))}l.mergeVertices();l.computeFaceNormals();var c=new THREE.Mesh(l,r);var C=new THREE.Geometry();for(i=0;i<e;++i){var y=i;var x=i*6;C.vertices.push(f.vertices[f.vertices.length-2-y+0]);C.vertices.push(f.vertices[f.vertices.length-2-y+1]);C.vertices.push(n.vertices[f.vertices.length-2-y+0]);C.faces.push(new THREE.Face3(x+0,x+1,x+2));C.vertices.push(n.vertices[f.vertices.length-2-y+0]);C.vertices.push(n.vertices[f.vertices.length-2-y+1]);C.vertices.push(f.vertices[f.vertices.length-2-y+1]);C.faces.push(new THREE.Face3(x+3,x+4,x+5))}C.mergeVertices();C.computeFaceNormals();var A=new THREE.Mesh(C,r);var q=new THREE.Geometry();for(i=0;i<e;++i){var y=e*i;var x=i*6;q.vertices.push(f.vertices[y+i]);q.vertices.push(f.vertices[y+e+i+1]);q.vertices.push(n.vertices[y+i]);q.faces.push(new THREE.Face3(x+0,x+1,x+2));q.vertices.push(n.vertices[y+i]);q.vertices.push(f.vertices[y+e+i+1]);q.vertices.push(n.vertices[y+e+i+1]);q.faces.push(new THREE.Face3(x+3,x+4,x+5))}q.mergeVertices();q.computeFaceNormals();var o=new THREE.Mesh(q,r);var p=new THREE.Geometry();for(i=0;i<e;++i){var y=e*(i+1);var x=i*6;p.vertices.push(f.vertices[y+i]);p.vertices.push(f.vertices[y+e+i+1]);p.vertices.push(n.vertices[y+i]);p.faces.push(new THREE.Face3(x+0,x+1,x+2));p.vertices.push(n.vertices[y+i]);p.vertices.push(f.vertices[y+e+i+1]);p.vertices.push(n.vertices[y+e+i+1]);p.faces.push(new THREE.Face3(x+3,x+4,x+5))}p.mergeVertices();p.computeFaceNormals();var b=new THREE.Mesh(p,r);z.updateMatrix();h.merge(z.geometry,z.matrix);B.updateMatrix();h.merge(B.geometry,B.matrix);c.updateMatrix();h.merge(c.geometry,c.matrix);A.updateMatrix();h.merge(A.geometry,A.matrix);o.updateMatrix();h.merge(o.geometry,o.matrix);b.updateMatrix();h.merge(b.geometry,b.matrix);return new THREE.Mesh(h,r)};a.TGeoPainter.prototype.createTorus=function(c,o){var e=c.fR;var z=c.fRmin;var y=c.fRmax;var d=30;var n=60;var m=c.fDphi-c.fPhi1;var s=c.fPhi1;s*=(Math.PI/180);m*=(Math.PI/180);var g=new THREE.Geometry();var x=new THREE.TorusGeometry(e/2,y/2,d,n,m);x.applyMatrix(new THREE.Matrix4().makeRotationZ(s));var p=new THREE.Mesh(x,o);var q=new THREE.TorusGeometry(e/2,z/2,d,n,m);q.applyMatrix(new THREE.Matrix4().makeRotationZ(s));var f=new THREE.Mesh(q,o);var h=new THREE.Geometry();for(i=0;i<d;++i){var u=i*(n+1);var t=i*6;var r=(i+1)*(n+1);h.vertices.push(x.vertices[u]);h.vertices.push(x.vertices[r]);h.vertices.push(q.vertices[u]);h.faces.push(new THREE.Face3(t+0,t+1,t+2));h.vertices.push(q.vertices[u]);h.vertices.push(q.vertices[r]);h.vertices.push(x.vertices[r]);h.faces.push(new THREE.Face3(t+3,t+4,t+5))}h.mergeVertices();h.computeFaceNormals();var b=new THREE.Mesh(h,o);var w=new THREE.Geometry();for(i=0;i<d;++i){var u=(i+1)*n;var t=i*6;var r=(i+2)*n;w.vertices.push(x.vertices[u+i]);w.vertices.push(x.vertices[r+i+1]);w.vertices.push(q.vertices[u+i]);w.faces.push(new THREE.Face3(t+0,t+1,t+2));w.vertices.push(q.vertices[u+i]);w.vertices.push(q.vertices[r+i+1]);w.vertices.push(x.vertices[r+i+1]);w.faces.push(new THREE.Face3(t+3,t+4,t+5))}w.mergeVertices();w.computeFaceNormals();var v=new THREE.Mesh(w,o);p.updateMatrix();g.merge(p.geometry,p.matrix);f.updateMatrix();g.merge(f.geometry,f.matrix);b.updateMatrix();g.merge(b.geometry,b.matrix);v.updateMatrix();g.merge(v.geometry,v.matrix);return new THREE.Mesh(g,o)};a.TGeoPainter.prototype.createTrapezoid=function(c,e){if(c._typename=="TGeoArb8"||c._typename=="TGeoTrap"){var b=[c.fXY[0][0],c.fXY[0][1],-1*c.fDZ,c.fXY[1][0],c.fXY[1][1],-1*c.fDZ,c.fXY[2][0],c.fXY[2][1],-1*c.fDZ,c.fXY[3][0],c.fXY[3][1],-1*c.fDZ,c.fXY[4][0],c.fXY[4][1],c.fDZ,c.fXY[5][0],c.fXY[5][1],c.fDZ,c.fXY[6][0],c.fXY[6][1],c.fDZ,c.fXY[7][0],c.fXY[7][1],c.fDZ]}else{if(c._typename=="TGeoTrd1"){var b=[-c.fDx1,c.fDY,-c.fDZ,c.fDx1,c.fDY,-c.fDZ,c.fDx1,-c.fDY,-c.fDZ,-c.fDx1,-c.fDY,-c.fDZ,-c.fDx2,c.fDY,c.fDZ,c.fDx2,c.fDY,c.fDZ,c.fDx2,-c.fDY,c.fDZ,-c.fDx2,-c.fDY,c.fDZ]}else{if(c._typename=="TGeoTrd2"){var b=[-c.fDx1,c.fDy1,-c.fDZ,c.fDx1,c.fDy1,-c.fDZ,c.fDx1,-c.fDy1,-c.fDZ,-c.fDx1,-c.fDy1,-c.fDZ,-c.fDx2,c.fDy2,c.fDZ,c.fDx2,c.fDy2,c.fDZ,c.fDx2,-c.fDy2,c.fDZ,-c.fDx2,-c.fDy2,c.fDZ]}}}var g=[4,5,6,4,7,6,0,3,7,7,4,0,4,5,1,1,0,4,6,2,1,1,5,6,7,3,2,2,6,7,1,2,3,3,0,1];var f=new THREE.Geometry();for(var d=0;d<24;d+=3){f.vertices.push(new THREE.Vector3(0.5*b[d],0.5*b[d+1],0.5*b[d+2]))}for(var d=0;d<36;d+=3){f.faces.push(new THREE.Face3(g[d],g[d+1],g[d+2]))}f.computeFaceNormals();return new THREE.Mesh(f,e)};a.TGeoPainter.prototype.createTube=function(d,p,w){var s=60;var f,z,e,y;if((d._typename=="TGeoCone")||(d._typename=="TGeoConeSeg")){f=d.fRmax2;z=d.fRmin2;e=d.fRmax1;y=d.fRmin1}else{f=e=d.fRmax;z=y=d.fRmin}if(z<=0){z=1e-7}if(y<=0){y=1e-7}var g=0;var r=360;if((d._typename=="TGeoConeSeg")||(d._typename=="TGeoTubeSeg")||(d._typename=="TGeoCtub")){g=d.fPhi1+90;r=d.fPhi2-d.fPhi1;if(w!==null&&w[4]===-1&&w[0]===1&&w[8]===1){g+=180}}g*=(Math.PI/180);r*=(Math.PI/180);var h=new THREE.Geometry();var B=new THREE.CylinderGeometry(f/2,e/2,d.fDZ,s,1,true,g,r);B.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));B.faceVertexUvs[0]=[];var q=new THREE.Mesh(B,p);var C=new THREE.CylinderGeometry(z/2,y/2,d.fDZ,s,1,true,g,r);C.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI/2));C.faceVertexUvs[0]=[];var u=new THREE.Mesh(C,p);var l=new THREE.Geometry();for(i=0;i<s;++i){var v=i;var t=i*6;l.vertices.push(B.vertices[v+0]);l.vertices.push(B.vertices[v+1]);l.vertices.push(C.vertices[v+0]);l.faces.push(new THREE.Face3(t+0,t+1,t+2));l.vertices.push(C.vertices[v+0]);l.vertices.push(C.vertices[v+1]);l.vertices.push(B.vertices[v+1]);l.faces.push(new THREE.Face3(t+3,t+4,t+5))}l.mergeVertices();l.computeFaceNormals();var c=new THREE.Mesh(l,p);var m,b;if((d._typename=="TGeoConeSeg")||(d._typename=="TGeoTubeSeg")||(d._typename=="TGeoCtub")){var o=new THREE.Geometry();o.vertices.push(B.vertices[0]);o.vertices.push(B.vertices[B.vertices.length/2]);o.vertices.push(C.vertices[B.vertices.length/2]);o.faces.push(new THREE.Face3(0,1,2));o.vertices.push(C.vertices[0]);o.vertices.push(C.vertices[B.vertices.length/2]);o.vertices.push(B.vertices[0]);o.faces.push(new THREE.Face3(3,4,5));o.mergeVertices();o.computeFaceNormals();m=new THREE.Mesh(o,p);var n=new THREE.Geometry();n.vertices.push(B.vertices[s]);n.vertices.push(B.vertices[B.vertices.length-1]);n.vertices.push(C.vertices[B.vertices.length-1]);n.faces.push(new THREE.Face3(0,1,2));n.vertices.push(C.vertices[s]);n.vertices.push(C.vertices[B.vertices.length-1]);n.vertices.push(B.vertices[s]);n.faces.push(new THREE.Face3(3,4,5));n.mergeVertices();n.computeFaceNormals();b=new THREE.Mesh(n,p)}var A=new THREE.Geometry();for(i=0;i<s;++i){var v=i;var t=i*6;A.vertices.push(B.vertices[B.vertices.length-2-v+0]);A.vertices.push(B.vertices[B.vertices.length-2-v+1]);A.vertices.push(C.vertices[B.vertices.length-2-v+0]);A.faces.push(new THREE.Face3(t+0,t+1,t+2));A.vertices.push(C.vertices[B.vertices.length-2-v+0]);A.vertices.push(C.vertices[B.vertices.length-2-v+1]);A.vertices.push(B.vertices[B.vertices.length-2-v+1]);A.faces.push(new THREE.Face3(t+3,t+4,t+5))}A.mergeVertices();A.computeFaceNormals();var x=new THREE.Mesh(A,p);q.updateMatrix();h.merge(q.geometry,q.matrix);u.updateMatrix();h.merge(u.geometry,u.matrix);if(m&&b){m.updateMatrix();h.merge(m.geometry,m.matrix);b.updateMatrix();h.merge(b.geometry,b.matrix)}c.updateMatrix();h.merge(c.geometry,c.matrix);x.updateMatrix();h.merge(x.geometry,x.matrix);return new THREE.Mesh(h,p)};a.TGeoPainter.prototype.createMesh=function(c,d,b){var e=null;if(c._typename=="TGeoBBox"){e=this.createCube(c,d)}else{if((c._typename=="TGeoArb8")||(c._typename=="TGeoTrd1")||(c._typename=="TGeoTrd2")||(c._typename=="TGeoTrap")){e=this.createTrapezoid(c,d)}else{if((c._typename=="TGeoSphere")){e=this.createSphere(c,d)}else{if((c._typename=="TGeoCone")||(c._typename=="TGeoConeSeg")||(c._typename=="TGeoTube")||(c._typename=="TGeoTubeSeg")){e=this.createTube(c,d,b)}else{if(c._typename=="TGeoTorus"){e=this.createTorus(c,d)}else{if(c._typename=="TGeoPcon"||c._typename=="TGeoPgon"){e=this.createPolygon(c,d,b)}}}}}}return e};a.TGeoPainter.prototype.drawNode=function(v,m,p,e){var l=m;var r=p.fVolume;var h=[0,0,0];var t=null;if(typeof p.fMatrix!="undefined"&&p.fMatrix!=null){if(p.fMatrix["_typename"]=="TGeoTranslation"){h=p.fMatrix["fTranslation"]}else{if(p.fMatrix["_typename"]=="TGeoRotation"){t=p.fMatrix["fRotationMatrix"]}else{if(p.fMatrix["_typename"]=="TGeoCombiTrans"){if(typeof p.fMatrix["fTranslation"]!="undefined"&&p.fMatrix["fTranslation"]!=null){h=p.fMatrix["fTranslation"]}if(typeof p.fMatrix["fRotation"]!="undefined"&&p.fMatrix["fRotation"]!=null){t=p.fMatrix["fRotation"]["fRotationMatrix"]}}}}}if(p._typename=="TGeoNodeOffset"){if(p.fFinder["_typename"]=="TGeoPatternX"){}if(p.fFinder["_typename"]=="TGeoPatternY"){}if(p.fFinder["_typename"]=="TGeoPatternZ"){}if(p.fFinder["_typename"]=="TGeoPatternParaX"){}if(p.fFinder["_typename"]=="TGeoPatternParaY"){}if(p.fFinder["_typename"]=="TGeoPatternParaZ"){}if(p.fFinder["_typename"]=="TGeoPatternTrapZ"){}if(p.fFinder["_typename"]=="TGeoPatternCylR"){}if(p.fFinder["_typename"]=="TGeoPatternSphR"){}if(p.fFinder["_typename"]=="TGeoPatternSphTheta"){}if(p.fFinder["_typename"]=="TGeoPatternSphPhi"){}if(p.fFinder["_typename"]=="TGeoPatternHoneycomb"){}if(p.fFinder["_typename"]=="TGeoPatternCylPhi"){if(typeof p.fFinder["fSinCos"]==="undefined"){p.fFinder["fSinCos"]=[];for(var s=0;s<p.fFinder["fNdivisions"];++s){p.fFinder["fSinCos"][2*s]=Math.sin((Math.PI/180)*(p.fFinder["fStart"]+0.5*p.fFinder["fStep"]+s*p.fFinder["fStep"]));p.fFinder["fSinCos"][2*s+1]=Math.cos((Math.PI/180)*(p.fFinder["fStart"]+0.5*p.fFinder["fStep"]+s*p.fFinder["fStep"]))}}if(t==null){t=[1,0,0,0,1,0,0,0,1]}t[0]=p.fFinder["fSinCos"][(2*p.fIndex)+1];t[1]=-p.fFinder["fSinCos"][(2*p.fIndex)];t[3]=p.fFinder["fSinCos"][(2*p.fIndex)];t[4]=p.fFinder["fSinCos"][(2*p.fIndex)+1]}}var w=a.Painter.root_colors[r.fLineColor];var g=true,j=false,n=0,f=false;if(this._debug){j=true}if(a.TestGeoAttBit(r,a.BIT(7))||(e>0&&a.TestGeoAttBit(r,a.BIT(2)))){g=false;n=1;f=true}if(typeof r.fMedium!="undefined"&&r.fMedium!=null&&typeof r.fMedium["fMaterial"]!="undefined"&&r.fMedium["fMaterial"]!=null){var d=r.fMedium["fMaterial"]["fFillStyle"];var q=(d<3000||d>3100)?0:d-3000;if(q>0){g=true;n=(100-q)/100}if(typeof w=="undefined"){w=a.Painter.root_colors[r.fMedium["fMaterial"]["fFillColor"]]}}var k=new THREE.MeshLambertMaterial({transparent:g,opacity:n,wireframe:false,color:w,side:THREE.DoubleSide,vertexColors:THREE.VertexColors,overdraw:false});if(!f){k.depthWrite=false;k.depthTest=false;k.visible=false}var c=this.createMesh(r.fShape,k,t);if(typeof c!="undefined"&&c!=null){c.position.x=0.5*h[0];c.position.y=0.5*h[1];c.position.z=0.5*h[2];if(t!==null){c.rotation.setFromRotationMatrix(new THREE.Matrix4().set(t[0],t[1],t[2],0,t[3],t[4],t[5],0,t[6],t[7],t[8],0,0,0,0,1))}if(f&&j){var b=new THREE.WireframeHelper(c);b.material.color.set(a.Painter.root_colors[r.fLineColor]);b.material.linewidth=r.fLineWidth;v.add(b)}if(this._debug&&this._bound){if(f||this._full){var u=new THREE.BoxHelper(c);m.add(u)}}c.name=p.fName;m.add(c);l=c}if(typeof r.fNodes!="undefined"&&r.fNodes!=null){var o=r.fNodes["arr"];for(var s in o){this.drawNode(v,l,o[s],e-1)}}};a.TGeoPainter.prototype.drawEveNode=function(t,l,o){var k=l;var d=o.fShape;var q=null;var b=null;var s=new THREE.Color(o.fRGBALine[0],o.fRGBALine[1],o.fRGBALine[2]);var u=new THREE.Color(o.fRGBA[0],o.fRGBA[1],o.fRGBA[2]);var f=true;var g=false;if(this._debug){g=true}var m=0;var e=false;if(o.fRnrSelf==true){f=false;m=1;e=true}if(o.fRGBA[3]<1){f=true;m=o.fRGBA[3]}var j=new THREE.MeshLambertMaterial({transparent:f,opacity:m,wireframe:false,color:u,side:THREE.DoubleSide,vertexColors:THREE.VertexColors,overdraw:false});if(!e){j.depthWrite=false;j.depthTest=false;j.visible=false}j.polygonOffset=true;j.polygonOffsetFactor=-1;if(d!==null){b=this.createMesh(d,j,q)}if(typeof b!="undefined"&&b!=null){b.position.x=0.5*o.fTrans[12];b.position.y=0.5*o.fTrans[13];b.position.z=0.5*o.fTrans[14];b.rotation.setFromRotationMatrix(new THREE.Matrix4().set(o.fTrans[0],o.fTrans[4],o.fTrans[8],0,o.fTrans[1],o.fTrans[5],o.fTrans[9],0,o.fTrans[2],o.fTrans[6],o.fTrans[10],0,0,0,0,1));if(e&&g){var c=new THREE.WireframeHelper(b);c.material.color.set(a.Painter.root_colors[volume.fLineColor]);c.material.linewidth=volume.fLineWidth;t.add(c)}if(this._debug&&this._bound){if(e||this._full){var r=new THREE.BoxHelper(b);l.add(r)}}b.name=o.fName;l.add(b);k=b}if(typeof o.fElements!="undefined"&&o.fElements!=null){var n=o.fElements["arr"];for(var p=0;p<n.length;++p){var h=o.fElements["arr"][p];this.drawEveNode(t,k,h)}}};a.TGeoPainter.prototype.computeBoundingBox=function(f,d){var e=null;for(var b=0;b<f.children.length;++b){var c=f.children[b];if(c instanceof THREE.Mesh){if(d||c.material["visible"]){e=new THREE.Box3().setFromObject(c);return e}else{e=this.computeBoundingBox(c,d);if(e!=null){return e}}}}return e};a.TGeoPainter.prototype.drawGeometry=function(b){var c=this.select_main().node().getBoundingClientRect();var g=c.width,t=c.height,l=100;if(t<10){t=parseInt(0.66*g);this.select_main().style("height",t+"px")}var u=this.select_main().node();this._scene=new THREE.Scene();this._scene.fog=new THREE.Fog(16777215,500,300000);this._camera=new THREE.PerspectiveCamera(25,g/t,1,100000);var q=new THREE.PointLight(15724527);this._camera.add(q);q.position.set(10,10,10);this._scene.add(this._camera);var v={canvas:!!window.CanvasRenderingContext2D,webgl:(function(){try{return !!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(h){return false}})(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob};this._renderer=v.webgl?new THREE.WebGLRenderer({antialias:true,logarithmicDepthBuffer:true}):new THREE.CanvasRenderer({antialias:true});this._renderer.setPixelRatio(window.devicePixelRatio);this._renderer.setClearColor(16777215,1);this._renderer.setSize(g,t);u.appendChild(this._renderer.domElement);this.SetDivId();this.addControls(this._renderer,this._scene,this._camera);var j=new THREE.Object3D();j.rotation.y=90*Math.PI/180;this._scene.add(j);var o=10;if((this._geometry._typename=="TGeoVolume")||(this._geometry._typename=="TGeoVolumeAssembly")){var d=this._geometry.fShape;var k=new THREE.BoxGeometry(d.fDX,d.fDY,d.fDZ);var p=new THREE.Mesh(k,new THREE.MeshBasicMaterial({visible:false,transparent:true,opacity:0}));j.add(p);this.drawNode(this._scene,p,{_typename:"TGeoNode",fVolume:this._geometry,fName:"TopLevel"},b=="all"?9999:0);k.computeBoundingBox();var o=3*Math.max(Math.max(Math.abs(k.boundingBox.max.x),Math.abs(k.boundingBox.max.y)),Math.abs(k.boundingBox.max.z))}else{if(this._geometry._typename=="TEveGeoShapeExtract"){if(typeof this._geometry.fElements!="undefined"&&this._geometry.fElements!=null){var m=this._geometry.fElements["arr"];for(var r=0;r<m.length;++r){var n=this._geometry.fElements["arr"][r];this.drawEveNode(this._scene,j,n)}}var f=this.computeBoundingBox(j,true);o=10*Math.max(Math.max(Math.abs(f.max.x),Math.abs(f.max.y)),Math.abs(f.max.z))}}if(this._debug||this._grid){if(this._full){var s=new THREE.BoxHelper(p);this._scene.add(s)}this._scene.add(new THREE.AxisHelper(2*o));this._scene.add(new THREE.GridHelper(Math.ceil(o),Math.ceil(o)/50));this._renderer.domElement._translationSnap=Math.ceil(o)/50;if(this._renderer.domElement.transformControl!==null){this._renderer.domElement.transformControl.attach(j)}this.helpText("<font face='verdana' size='1' color='red'><center>Transform Controls<br>'T' translate | 'R' rotate | 'S' scale<br>'+' increase size | '-' decrease size<br>'W' toggle wireframe/solid display<br>keep 'Ctrl' down to snap to grid</center></font>")}this._camera.near=o/200;this._camera.far=o*500;this._camera.updateProjectionMatrix();this._camera.position.x=o*Math.cos(135);this._camera.position.y=o*Math.cos(45);this._camera.position.z=o*Math.sin(45);this._renderer.render(this._scene,this._camera);var e=this;u.tabIndex=0;u.focus();u.onkeypress=function(h){if(!h){h=event}switch(h.keyCode){case 87:case 119:e.toggleWireFrame(e._scene);break}};u.onclick=function(h){this.focus()};return this.DrawingReady()};a.TGeoPainter.prototype.Cleanup=function(){this.helpText();if(this._scene===null){return}this._renderer.domElement.clock=null;if(this._renderer.domElement._timeoutFunc!=null){clearTimeout(this._renderer.domElement._timeoutFunc)}if(this._renderer.domElement._animationId!=null){cancelAnimationFrame(this._renderer.domElement._animationId)}this.deleteChildren(this._scene);delete this._scene;this._scene=null;if(this._renderer.domElement.transformControl!==null){this._renderer.domElement.transformControl.dispose()}this._renderer.domElement.transformControl=null;this._renderer.domElement.trackballControls=null;this._renderer.domElement.render=null;this._renderer=null};a.TGeoPainter.prototype.helpText=function(d){var e="jsroot_helptext";var b=d3.select("#"+e);var c=true;if((typeof d=="undefined")||(d==null)){if(b.empty()){return}b.property("stack").pop();if(b.property("stack").length==0){return b.remove()}d=b.property("stack")[b.property("stack").length-1];c=false}if(b.empty()){b=d3.select(document.body).append("div").attr("id",e).attr("class","progressbox").property("stack",new Array);b.append("p")}b.select("p").html(d);if(c){b.property("stack").push(d);b.property("showtm",new Date)}};a.TGeoPainter.prototype.CheckResize=function(b){var c=this.select_main().node().getBoundingClientRect();if((b!=null)&&("width" in b)&&("height" in b)){c=b}if((c.width<10)||(c.height<10)){return}this._camera.aspect=c.width/c.height;this._camera.updateProjectionMatrix();this._renderer.setSize(c.width,c.height)};ownedByTransformControls=function(c){var b=c.parent;while(b&&!(b instanceof THREE.TransformControls)){b=b.parent}return(b&&(b instanceof THREE.TransformControls))};a.TGeoPainter.prototype.toggleWireFrame=function(c){var b=function(d){if(d.hasOwnProperty("material")&&!(d instanceof THREE.GridHelper)){if(!ownedByTransformControls(d)){d.material.wireframe=!d.material.wireframe}}};c.traverse(b)};a.TGeoPainter.prototype.deleteChildren=function(f){if((typeof f.children!="undefined")&&(f.children instanceof Array)){for(var c=f.children.length-1;c>=0;c--){var b=f.children[c];this.deleteChildren(b);try{f.remove(f.children[c])}catch(d){}try{b.geometry.dispose();b.geometry=null}catch(d){}try{b.material.dispose();b.material=null}catch(d){}try{b.texture.dispose();b.texture=null}catch(d){}b=null;f.children[c]=null}f.children=null}f=null};a.Painter.drawGeometry=function(d,c,b){a.extend(this,new a.TGeoPainter(c));this.SetDivId(d);return this.drawGeometry(b)};a.expandGeoList=function(c,b){if((b==null)||!("arr" in b)||(b.arr.length==0)){return}c._more=true;c._geolst=b;c._get=function(d,f,e){if("_geolst" in d){a.CallBack(e,d,d._geolst)}if("_geoobj" in d){return a.CallBack(e,d,d._geoobj)}a.CallBack(e,d,null)};c._expand=function(f,d){if(!("arr" in d)){return false}f._childs=[];for(var h in d.arr){var g=d.arr[h];var e={_kind:"ROOT."+g._typename,_name:g.fName,_title:g.fTitle,_parent:f,_geoobj:g};if(g._typename=="TGeoMaterial"){e._icon="img_geomaterial"}else{if(g._typename=="TGeoMedium"){e._icon="img_geomedium"}else{if(g._typename=="TGeoMixture"){e._icon="img_geomixture"}}}f._childs.push(e)}return true}};a.provideGeoVisStyle=function(c){var b="";if(a.TestGeoAttBit(c,a.EGeoVisibilityAtt.kVisThis)){b+=" geovis_this"}if(a.TestGeoAttBit(c,a.EGeoVisibilityAtt.kVisDaughters)){b+=" geovis_daughters"}return b};a.provideGeoMenu=function(f,c,d){if(!("_volume" in c)){return false}f.add("separator");var b=c._volume;function e(g){a.ToggleGeoAttBit(b,g);c._icon=c._icon.split(" ")[0]+a.provideGeoVisStyle(b);d.UpdateTreeNode(c)}f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisNone),"Invisible",a.EGeoVisibilityAtt.kVisNone,e);f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisThis),"Visible",a.EGeoVisibilityAtt.kVisThis,e);f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisDaughters),"Daughters",a.EGeoVisibilityAtt.kVisDaughters,e);f.addchk(a.TestGeoAttBit(b,a.EGeoVisibilityAtt.kVisOneLevel),"1lvl daughters",a.EGeoVisibilityAtt.kVisOneLevel,e);return true};a.geoIconClick=function(b){if((b==null)||(b._volume==null)){return false}a.ToggleGeoAttBit(b._volume,a.EGeoVisibilityAtt.kVisDaughters);b._icon=b._icon.split(" ")[0]+a.provideGeoVisStyle(b._volume);return true};a.expandGeoVolume=function(e,g,b){if((e==null)||(g==null)){return false}var f={_kind:"ROOT.TGeoVolume",_name:(b!=null)?b:g.fName,_title:g.fTitle,_parent:e,_volume:g,_more:(typeof g.fNodes!="undefined")&&(g.fNodes!=null),_menu:a.provideGeoMenu,_icon_click:a.geoIconClick,_get:function(j,l,k){if((j!=null)&&(j._volume!=null)){return a.CallBack(k,j,j._volume)}a.CallBack(k,j,null)}};if(f._more){f._expand=function(k,m){var l=m.fNodes["arr"];for(var j in l){a.expandGeoVolume(k,l[j]["fVolume"])}return true}}if(f._title==""){if(g._typename!="TGeoVolume"){f._title=g._typename}}if(g.fShape!=null){if(f._title==""){f._title=g.fShape._typename}switch(g.fShape._typename){case"TGeoArb8":f._icon="img_geoarb8";break;case"TGeoCone":f._icon="img_geocone";break;case"TGeoConeSeg":f._icon="img_geoconeseg";break;case"TGeoCompositeShape":f._icon="img_geocomposite";break;case"TGeoTube":f._icon="img_geotube";break;case"TGeoTubeSeg":f._icon="img_geotubeseg";break;case"TGeoPara":f._icon="img_geopara";break;case"TGeoParaboloid":f._icon="img_geoparab";break;case"TGeoPcon":f._icon="img_geopcon";break;case"TGeoPgon":f._icon="img_geopgon";break;case"TGeoShapeAssembly":f._icon="img_geoassembly";break;case"TGeoSphere":f._icon="img_geosphere";break;case"TGeoTorus":f._icon="img_geotorus";break;case"TGeoTrd1":f._icon="img_geotrd1";break;case"TGeoTrd2":f._icon="img_geotrd2";break;case"TGeoXtru":f._icon="img_geoxtru";break;case"TGeoTrap":f._icon="img_geotrap";break;case"TGeoGtra":f._icon="img_geogtra";break;case"TGeoEltu":f._icon="img_geoeltu";break;case"TGeoHype":f._icon="img_geohype";break;case"TGeoCtub":f._icon="img_geoctub";break}}if(!("_childs" in e)){e._childs=[]}if(!("_icon" in f)){f._icon=f._more?"img_geocombi":"img_geobbox"}f._icon+=a.provideGeoVisStyle(g);for(var d=0;d<1000000;d++){var c=f._name;if(c.length==0){c="item"}if(d>0){c+="_"+d}for(var h in e._childs){if(e._childs[h]["_name"]==c){c="";break}}if(c.length>0){if(d>0){f._name=c}break}}e._childs.push(f);return true};a.expandGeoManagerHierarchy=function(e,f){if((e==null)||(f==null)){return false}e._childs=[];var d={_name:"Materials",_kind:"Folder",_title:"list of materials"};a.expandGeoList(d,f.fMaterials);e._childs.push(d);var c={_name:"Media",_kind:"Folder",_title:"list of media"};a.expandGeoList(c,f.fMedia);e._childs.push(c);var b={_name:"Tracks",_kind:"Folder",_title:"list of tracks"};a.expandGeoList(b,f.fTracks);e._childs.push(b);a.expandGeoVolume(e,f.fMasterVolume,"Volume");return true};a.addDrawFunc({name:"TGeoVolumeAssembly",icon:"img_geoassembly",func:a.Painter.drawGeometry,expand:"JSROOT.expandGeoVolume",painter_kind:"base"});return a.Painter}));